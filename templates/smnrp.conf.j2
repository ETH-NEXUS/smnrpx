{% for domain_name, domain in domains.items() %}
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

{% if domain.upstreams %}
{% for upstream_name, upstream in domain.upstreams.items() %}
upstream {{ upstream_name }} {
    {% for endpoint in upstream %}
    server {{ endpoint }} max_fails=3 fail_timeout=10s;
    keepalive 32;
    {% endfor %}
}
{% endfor %}
{% endif %}

server {
  {% if domain.ports and domain.ports.http %}
  listen {{ domain.ports.http }};
  {% else %}
  listen 80;
  {% endif %}
  http2 on;
  server_name {{ domain_name }} {{ domain.sans|join(' ') }};

  {% if certrequest %}
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }
  {% else %}
  location / {
    return 301 https://{{domain_name}}{{':' ~ domain.ports.https if domain.ports and domain.ports.https and domain.ports.https != '443'}}$request_uri;
  }
  {% endif %}
}

{% if not certrequest %}
server {
  {% if domain.ports and domain.ports.https %}
  listen {{ domain.ports.https }} ssl;
  {% else %}
  listen 443 ssl;
  {% endif %}
  http2 on;
  server_name {{ domain_name }} {{ domain.sans|join(' ') }};

  ssl_certificate "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem";
  ssl_certificate_key "/etc/letsencrypt/live/{{ domain_name }}/privkey.pem";

  ssl_dhparam /etc/letsencrypt/{{domain_name}}-dhparams.pem;

  {% if domain["allow_tsl1.2"] %}
  ssl_protocols TLSv1.2 TLSv1.3;
  {% else %}
  ssl_protocols TLSv1.3;
  {% endif %}
  ssl_ecdh_curve X25519:prime256v1:secp384r1;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;

  ssl_session_cache shared:le_nginx_SSL:10m;
  ssl_session_timeout 1440m;
  ssl_session_tickets off;

  {% if domain.cert and domain.cert != 'self-signed' and domain.disable_ocsp_stapling %}
  ssl_stapling on;
  ssl_stapling_verify on;
  resolver 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;
  {% endif %}

  add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";

  proxy_hide_header Referrer-Policy;
  add_header Referrer-Policy strict-origin-when-cross-origin;
  
  add_header X-Frame-Options "SAMEORIGIN";
  add_header X-Content-Type-Options nosniff;
  add_header Cache-Control no-cache="Set-Cookie";
  
  {% if domain.csp %}
  add_header Content-Security-Policy "{{ domain.csp }}" always;
  {% endif %}

  proxy_read_timeout 180s;
  proxy_buffers 8 32k;
  {% if domain.proxy_buffer_size %}
  proxy_buffer_size {{ domain.proxy_buffer_size }};
  {% else %}
  proxy_buffer_size 32k;
  {% endif %}
  error_log  /dev/stdout;
  access_log  /dev/stdout combined;

  root /web_root/{{ domain_name }};
  index index.html;

  {% if domain.client_max_body_size %}
  client_max_body_size {{ domain.client_max_body_size }};
  {% else %}
  client_max_body_size 1m;
  {% endif %}

  {% if domain.server_tokens %}
  server_tokens {{ domain.server_tokens }};
  {% else %}
  server_tokens off;
  {% endif %}
  {% if domain.client_body_buffer_size %}
  client_body_buffer_size {{ domain.client_body_buffer_size }};
  {% else %}
  client_body_buffer_size 1k;
  {% endif %}

  include /etc/nginx/conf.d/custom/{{ domain_name }}/*.nginx;

  if ( -f $document_root/.maintenance ) {
    return 503;
  }

  error_page 401 @auth_required;
  error_page 404 /error/404.html;
  error_page 403 =404 /error/404.html;
  error_page 500 501 502 504 /error/50x.html;
  error_page 503 @maintenance;

  location @maintenance {
    root /usr/share/nginx/html;
    rewrite ^(.*)$ /error/maintenance.html break;
  }

  location @auth_required {
    root /usr/share/nginx/html;
    rewrite ^(.*)$ /error/auth_required.html break;
  }

  location /error/ {
    root /usr/share/nginx/html;
  }

  {% if domain.locations %}
  {% for location in domain.locations %}
  {% if location.proxy %}
  location {{ location.proxy.uri }} {
    {% if location.proxy.whitelist %}
    {% for ip in location.proxy.whitelist %}
    allow {{ip}};
    {% endfor %}
    deny all;
    {% endif %}
    {% if location.proxy.auth %}
    auth_basic "Authorization Required";
    auth_basic_user_file /etc/nginx/conf.d/.auth_{{domain_name}}{{location.proxy.uri|replace("/", "_")}};
    {% endif %}
    {% if location.proxy.disable_cache %}
    add_header Last-Modified $date_gmt;
    add_header Cache-Control 'private no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    if_modified_since off;
    expires off;
    etag off;
    {% endif %}
    {% if not location.proxy.disable_default_headers %}
    # proxy_redirect off;
    proxy_buffering off;
    proxy_set_header Host $host;
    proxy_set_header X-Original-Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Scheme $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Ssl on;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_set_header Cookie $http_cookie;
    proxy_pass_request_headers on;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_cache_bypass $http_upgrade;
    {% endif %}
    {% if location.proxy.custom%}
    {% for custom in location.proxy.custom %}
    {{ custom }};
    {% endfor %}
    {% endif %}
    {% if location.proxy.disable_default_headers and not location.proxy.custom %}
    {# set this headers if defaults are disabled and no custom headers are enabled #}
    proxy_set_header Host $host;
    {% endif %}
    proxy_pass {{ location.proxy.proto }}://{{ location.proxy.upstream }}{{ location.proxy.path }};
  }
  {% endif %}
  {% if location.alias %}
  location {{location.alias.uri }} {
    {% if location.alias.whitelist %}
    {% for ip in location.alias.whitelist %}
    allow {{ip}};
    {% endfor %}
    deny all;
    {% endif %}
    {% if location.alias.auth %}
    auth_basic "Authorization Required";
    auth_basic_user_file /etc/nginx/conf.d/.auth_{{domain_name}}{{location.alias.uri|replace("/", "_")}};
    {% endif %}
    {% if location.alias.disable_cache %}
    add_header Last-Modified $date_gmt;
    add_header Cache-Control 'private no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    if_modified_since off;
    expires off;
    etag off;
    {% endif %}
    {% if location.internal %}
    internal;
    {% endif %}
    alias {{ location.alias.path }};
    {% if location.try_files %}
    try_files $uri $uri/ /index.html;
    {% endif %}
    {% if location.alias.custom %}
    {% for custom in location.alias.custom %}
    {{ custom }}
    {% endfor %}
    {% endif %}
  }
  {% endif %}
  {% if location.redirect %}
  location {{location.redirect.uri }} {
    return 301 {{ location.redirect.url }};
  }
  {% endif %}
  {% endfor %}
  {% endif %}
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }
}
{% endif %} {# end of if not certrequest #}
{% endfor %} {# end for domains #}
