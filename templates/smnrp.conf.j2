{% for domain_name, domain in domains.items() %}
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

{% if domain.upstreams %}
{% for upstream_name, upstream in domain.upstreams.items() %}
upstream {{ upstream_name }} {
    {% for endpoint in upstream %}
    server {{ endpoint }} max_fails=3 fail_timeout=10s;
    keepalive 32;
    {% endfor %}
}
{% endfor %}
{% endif %}

server {
  {% if domain.ports and domain.ports.http %}
  listen {{ domain.ports.http }};
  {% else %}
  listen 80;
  {% endif %}
  http2 on;
  server_name {{ domain_name }};

  {% if certrequest %}
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }
  {% else %}
  location / {
    return 301 https://{{domain_name}}{{':' ~ domain.ports.https if domain.ports and domain.ports.https and domain.ports.https != '443'}}$request_uri;
  }
  {% endif %}
}

{% if not certrequest %}
server {
  {% if domain.ports and domain.ports.https %}
  listen {{ domain.ports.https }} ssl;
  {% else %}
  listen 443 ssl;
  {% endif %}
  http2 on;
  server_name {{ domain_name }};

  ssl_certificate "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem";
  ssl_certificate_key "/etc/letsencrypt/live/{{ domain_name }}/privkey.pem";

  ssl_dhparam /usr/share/nginx/ssl-dhparams.pem;

  ssl_protocols TLSv1.3;
  ssl_ecdh_curve X25519:prime256v1:secp384r1;
  ssl_prefer_server_ciphers off;

  ssl_session_cache shared:le_nginx_SSL:10m;
  ssl_session_timeout 1440m;
  ssl_session_tickets off;

  {% if domain.cert and domain.cert != 'self-signed' %}
  ssl_stapling on;
  ssl_stapling_verify on;
  resolver 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;
  {% endif %}

  add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";

  proxy_hide_header Referrer-Policy;
  add_header Referrer-Policy strict-origin-when-cross-origin;
  
  add_header X-Frame-Options "SAMEORIGIN";
  add_header X-Content-Type-Options nosniff;
  add_header Cache-Control no-cache="Set-Cookie";
  
  {% if domain.csp %}
  add_header Content-Security-Policy "{{ domain.csp }}" always;
  {% endif %}

  proxy_read_timeout 180s;
  proxy_buffers 8 32k;
  {% if domain.proxy_buffer_size %}
  proxy_buffer_size {{ domain.proxy_buffer_size }};
  {% else %}
  proxy_buffer_size 32k;
  {% endif %}
  error_log  /dev/stdout;
  access_log  /dev/stdout combined;

  root /web_root/{{ domain_name }};
  index index.html;

  {% if domain.client_max_body_size %}
  client_max_body_size {{ domain.client_max_body_size }};
  {% else %}
  client_max_body_size 1m;
  {% endif %}

  {% if domain.server_tokens %}
  server_tokens {{ domain.server_tokens }};
  {% else %}
  server_tokens off;
  {% endif %}
  {% if domain.client_body_buffer_size %}
  client_body_buffer_size {{ domain.client_body_buffer_size }};
  {% else %}
  client_body_buffer_size 1k;
  {% endif %}

  include /etc/nginx/conf.d/custom/{{ domain_name }}/*.nginx;

  if ( -f $document_root/.maintenance ) {
    return 503;
  }

  error_page 401 @auth_required;
  error_page 404 /error/404.html;
  error_page 403 =404 /error/404.html;
  error_page 500 501 502 504 /error/50x.html;
  error_page 503 @maintenance;

  location @maintenance {
    root /usr/share/nginx/html;
    rewrite ^(.*)$ /error/maintenance.html break;
  }

  location @auth_required {
    root /usr/share/nginx/html;
    rewrite ^(.*)$ /error/auth_required.html break;
  }

  location /error/ {
    root /usr/share/nginx/html;
  }

  {% if domain.locations %}
  {% for location in domain.locations %}
  {% if location.proxy %}
  location {{ location.proxy.uri }} {
    proxy_set_header Host $host;
    proxy_pass {{ location.proxy.proto }}://{{ location.proxy.upstream }}{{ location.proxy.path }};
  }
  {% endif %}
  {% if location.alias %}
  location {{location.alias.uri }} {
    alias {{ location.alias.path }};
  }
  {% endif %}
  {% if location.redirect %}
  location {{location.redirect.uri }} {
    return 301 {{ location.redirect.url }};
  }
  {% endif %}
  {% endfor %}
  {% endif %}
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }
}
{% endif %} {# end of if not certrequest #}
{% endfor %} {# end for domains #}
